<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width">
    <meta charset="utf-8" />

    <!--
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://maps.googleapis.com/ https://maps.gstatic.com/ https://mts0.googleapis.com/ 'unsafe-inline' 'unsafe-eval'">
    -->
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/cicer.js"></script>
    <script type="text/javascript">
    document.addEventListener("deviceready", function() {
      var div = document.getElementById("map_canvas");
      // If your app runs this program on browser,
      // you need to set `API_KEY_FOR_BROWSER_RELEASE` and `API_KEY_FOR_BROWSER_DEBUG`
      // before `plugin.google.maps.Map.getMap()`
      //
      //   API_KEY_FOR_BROWSER_RELEASE for `https:` protocol
      //   API_KEY_FOR_BROWSER_DEBUG for `http:` protocol
      //
      // If your app does not use browser,
      // you can comment out this code.
      plugin.google.maps.environment.setEnv({
        'API_KEY_FOR_BROWSER_RELEASE': 'AIzaSyBH3UAFCsjhDeUzqS9irouUWf3dx_Mgofk',
        'API_KEY_FOR_BROWSER_DEBUG': 'AIzaSyBH3UAFCsjhDeUzqS9irouUWf3dx_Mgofk'
      });

      // Create a Google Maps native view under the map_canvas div.
      var map = plugin.google.maps.Map.getMap(div);

      // window.geofence is now available
      window.geofence.initialize().then(function () {
          console.log("Successful initialization");
      }, function (error) {
          console.log("Error", error);
      });
      

      // If you click the button, do something...
      var button = document.getElementById("button");
      button.addEventListener("click", function() {

        const puertaSol = createPOI(40.4167321, -3.7035285, "Puerta del sol", "No dejes de poner el pie en el km0", "Su nombre se debe a que antiguamente era la plaza más al este de la villa, de manera que era la primera por la que entraba el sol.");
        const mallorquina = createPOI(40.4166912, -3.7048091, "La mallorquina", "Haz la cola para subir al salón", "La gracia está en partir en cuatro partes iguales un merengue sin desmoronarlo... y en comérselo.");
        const reta = createPOI(38.667046, -4.228267, "cerca", "camino de la cerca");
        var poiList = [reta];

        // Move to the position with animation
        map.animateCamera({
          target: {lat: reta.lat, lng: reta.lng},
          zoom: 17,
          tilt: 60,
          bearing: 140,
          duration: 5000
        });

        poiList.forEach(function(poi, i) {
			console.log("i:" +i);
          // Add a maker
          var marker = map.addMarker({
            position: {lat: poi.lat, lng: poi.lng},
            title: poi.title,
            snippet: poi.snippet,
            animation: plugin.google.maps.Animation.BOUNCE
          });

          window.geofence.addOrUpdate({
              id:             i+"id", //A unique identifier of geofence
              latitude:       poi.lat, //Geo latitude of geofence
              longitude:      poi.lng, //Geo longitude of geofence
              radius:         15, //Radius of geofence in meters
              transitionType: 1, //Type of transition 1 - Enter, 2 - Exit, 3 - Both
              notification: {         //Notification object
                  id:             i, //optional should be integer, id of notification
                  title:          "Has entrado en " + poi.title, //Title of notification
                  text:           poi.snippet, //Text of notification
                  //smallIcon:      String, //Small icon showed in notification area, only res URI
                  //icon:           String, //icon showed in notification drawer
                  openAppOnClick: true,//is main app activity should be opened after clicking on notification
                  vibration:      [1000, 500, 2000], //Optional vibration pattern - see description
                  //data:           Object  //Custom object associated with notification
              }
          }).then(function () {
              console.log('Geofence successfully added');
          }, function (error) {
              console.log('Adding geofence failed', error);
          });
          
 
          if (i==0) {
            // Show the info window
            marker.showInfoWindow();
          }

        });

      });

    }, false);

    </script>
    <style type="text/css">
    html, body {
      height: 100%;
    }
    #map_canvas { /* Must bigger size than 100x100 pixels */
      width: 100%;
      height: 80%;
    }
    button {
      padding: .5em;
      margin: .5em;
    }
    </style>
  </head>
  <body>
    <h1>Hello, World</h1>
    <div id="map_canvas">
      <button id="button">Click me...</button>
    </div>
  </body>
</html>
